# Архитектура системы для множественных автопрокатов

## Обзор

Этот документ описывает архитектуру системы для управления множественными автопрокатами, где каждый администратор управляет своим автопрокатом, и клиенты попадают именно к тому автопрокату, который их пригласил.

## Текущая архитектура приложения

Наше текущее приложение использует:
- **Хранение данных**: localStorage (локальное хранение на устройстве пользователя)
- **Идентификация**: Telegram WebApp API (идентификация через Telegram)
- **Бот**: Отправляет пользователей на веб-приложение через кнопку web_app

## Проблемы текущей архитектуры для масштабирования

1. **Изоляция данных**: Каждый пользователь имеет свои локальные данные, не связанные с другими
2. **Отсутствие серверной части**: Нет централизованного хранилища данных
3. **Нет системы приглашений**: Нет механизма для отслеживания, кто кого пригласил

## Предлагаемая архитектура для системы с 30 администраторами

### 1. Серверная архитектура

```
Клиенты (Telegram) ←→ Бот ←→ API Сервер ←→ База данных
                           ↑
Администраторы (Web App) --+
```

### 2. Компоненты системы

#### A. База данных
- **Таблица администраторов**: id, telegram_id, имя, email, company_name
- **Таблица автопрокатов**: id, admin_id, название, описание
- **Таблица автомобилей**: id, rental_id, марка, модель, госномер и т.д.
- **Таблица клиентов**: id, telegram_id, имя, invited_by_admin_id, rental_id
- **Таблица приглашений**: id, admin_id, invite_code, created_at

#### B. API Сервер
- **Аутентификация администраторов**: По Telegram ID
- **Управление автопрокатом**: CRUD операции с автомобилями
- **Система приглашений**: Генерация уникальных кодов приглашений
- **API для клиентов**: Получение списка автомобилей по приглашению

#### C. Бот для клиентов
- **Команда /start [invite_code]**: Регистрация клиента по коду приглашения
- **Команда /cars**: Показ автомобилей автопроката, который пригласил клиента
- **Команда /rent [car_id]**: Аренда автомобиля

#### D. Веб-приложение для администраторов
- **Аутентификация**: Через Telegram WebApp
- **Управление автомобилями**: Добавление, редактирование, удаление
- **Генерация приглашений**: Создание уникальных кодов для приглашения клиентов
- **Статистика**: Просмотр клиентов и аренд

### 3. Процесс работы

#### Регистрация администратора:
1. Администратор открывает веб-приложение через Telegram
2. Система идентифицирует его по Telegram ID
3. Создается запись об администраторе и его автопрокате

#### Приглашение клиентов:
1. Администратор генерирует уникальный код приглашения
2. Клиент переходит по ссылке с кодом приглашения
3. Система связывает клиента с автопрокатом администратора

#### Работа с клиентами:
1. Клиенты видят только автомобили того автопроката, который их пригласил
2. Все операции с клиентами привязаны к конкретному автопрокату

### 4. Техническая реализация

#### A. База данных (пример на PostgreSQL):
```sql
CREATE TABLE admins (
  id SERIAL PRIMARY KEY,
  telegram_id BIGINT UNIQUE NOT NULL,
  first_name VARCHAR(100),
  username VARCHAR(100),
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE rentals (
  id SERIAL PRIMARY KEY,
  admin_id INTEGER REFERENCES admins(id),
  name VARCHAR(200) NOT NULL,
  description TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE cars (
  id SERIAL PRIMARY KEY,
  rental_id INTEGER REFERENCES rentals(id),
  brand VARCHAR(100),
  model VARCHAR(100),
  plate VARCHAR(20),
  year INTEGER,
  color VARCHAR(50),
  price_per_day DECIMAL(10,2),
  status VARCHAR(20) DEFAULT 'available',
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE clients (
  id SERIAL PRIMARY KEY,
  telegram_id BIGINT UNIQUE NOT NULL,
  first_name VARCHAR(100),
  invited_by_admin_id INTEGER REFERENCES admins(id),
  rental_id INTEGER REFERENCES rentals(id),
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE invite_codes (
  id SERIAL PRIMARY KEY,
  admin_id INTEGER REFERENCES admins(id),
  code VARCHAR(50) UNIQUE NOT NULL,
  used BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT NOW()
);
```

#### B. API эндпоинты:
- `POST /api/auth/telegram` - Аутентификация через Telegram
- `GET /api/rentals` - Получение списка автопрокатов
- `POST /api/cars` - Добавление автомобиля
- `GET /api/cars` - Получение списка автомобилей
- `POST /api/invite-codes` - Генерация кода приглашения
- `POST /api/clients/register` - Регистрация клиента по коду

#### C. Модификация бота:
```javascript
// Обработка команды /start с кодом приглашения
bot.onText(/\/start (.+)/, async (msg, match) => {
  const chatId = msg.chat.id;
  const inviteCode = match[1];
  
  // Проверяем код приглашения
  const invite = await checkInviteCode(inviteCode);
  if (invite && !invite.used) {
    // Регистрируем клиента
    await registerClient(chatId, msg.from.first_name, invite.admin_id);
    // Помечаем код как использованный
    await markInviteCodeAsUsed(inviteCode);
    
    bot.sendMessage(chatId, 'Добро пожаловать! Вы приглашены в автопрокат.');
  } else {
    bot.sendMessage(chatId, 'Неверный или уже использованный код приглашения.');
  }
});
```

### 5. Преимущества такой архитектуры

1. **Изоляция данных**: Каждый автопрокат имеет свои данные
2. **Масштабируемость**: Можно добавлять неограниченное количество администраторов
3. **Отслеживаемость**: Можно отследить, кто кого пригласил
4. **Централизованное управление**: Все данные хранятся на сервере
5. **Безопасность**: Контроль доступа к данным

### 6. Приглашение как ссылка

Приглашение может быть реализовано как ссылка через команду `/start` в Telegram:

#### Формат ссылки:
```
https://t.me/ваш_бот?start=UNIQUE_CODE
```

#### Пример реализации:

1. **Генерация ссылки администратором:**
   - Администратор нажимает "Создать приглашение" в веб-приложении
   - Система генерирует уникальный код (например, `abc123xyz`)
   - Создается ссылка: `https://t.me/ваш_бот?start=abc123xyz`

2. **Использование ссылки клиентом:**
   - Клиент переходит по ссылке
   - Telegram автоматически отправляет боту команду `/start abc123xyz`
   - Бот распознает код приглашения и регистрирует клиента

#### Преимущества ссылок:
- Удобство для пользователя (один клик)
- Автоматическая обработка через `/start` команду
- Легкость распространения
- Возможность отслеживания источника приглашения

#### Альтернативные варианты:
1. **Текстовый код**: Просто код для ввода в боте (`ABC123XYZ`)
2. **QR-код**: Визуальное представление ссылки
3. **Кнопка в интерфейсе**: Встроенная кнопка "Пригласить" в веб-приложении

Ссылка через `/start` команду - самый распространенный и удобный способ в Telegram.